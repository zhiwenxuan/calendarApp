function getCurrentDb(){var db=openDatabase("calendarDb","","日历",1024*1024,function(){});return db}function createTable(){var db=getCurrentDb();if(!db){alert("您的浏览器不支持HTML5本地数据库");return}db.transaction(function(trans){trans.executeSql("create table if not exists planList(id int null, dayNo text null, beginTime text null, endTime text null, affair text null, bgcolor text null)",[],function(trans,result){console.info("创建数据表planList成功"+result)},function(trans,message){console.info("创建数据表planList失败",message)});trans.executeSql("create table if not exists log(id int null, operation text null, Time text null)",[],function(trans,result){console.info("创建数据表plog成功"+result)},function(trans,message){console.info("创建数据表log失败",message)})})}createTable();$("#add-plan").click(function(){selectPlanList();$(".add-container").attr("style","display:block;");$(".details").attr("style","opacity: 0.3;");$(".main").attr("style","opacity: 0.3;")});$("#add-main-button").click(function(){var dayNo=$("#add-weekdayNo").find("option:selected").text();var beginTime=$("#add-beginTime").find("option:selected").text();var endTime=$("#add-endTime").find("option:selected").text();var affair=$("input[name='affair']").val();var bgcolor=$("#add-bgcolor").find("option:selected").text();var id=0;if(beginTime>=endTime){window.alert("beginTime is not bigger than endTime!")}else{insertPlanList(id,dayNo,beginTime,endTime,affair,bgcolor);$(".add-container").attr("style","display:none;");$(".details").attr("style","opacity: 1;");$(".main").attr("style","opacity: 1;")}});$("#cancel-add-button").click(function(){selectPlanList();$(".add-container").attr("style","display:none;");$(".details").attr("style","opacity: 1;");$(".main").attr("style","opacity: 1;")});function insertPlanList(id,dayNo,beginTime,endTime,affair,bgcolor){var db=getCurrentDb();db.transaction(function(ts){var size=localStorage.getItem("psize");if(size==null){localStorage.setItem("psize",1);id=1}else{size=parseInt(size)+parseInt(1);localStorage.setItem("psize",size);id=size}ts.executeSql("insert into planList(id,dayNo,beginTime,endTime,affair,bgcolor) values(?,?,?,?,?,?) ",[id,dayNo,beginTime,endTime,affair,bgcolor],function(ts,result){console.dir("插入数据成功！"+result);selectPlanList();insertLog("new plan card")},function(ts,message){console.info("插入数据失败！"+message)})})}function selectPlanList(){var db=getCurrentDb();db.transaction(function(ts){ts.executeSql("select * from planList ",[],function(ts,result){if(result){for(var i=0;i<result.rows.length;i++){console.info((result.rows.item(i)));var id=result.rows.item(i).id;var beginTime=result.rows.item(i).beginTime;var endTime=result.rows.item(i).endTime;var dayNo=result.rows.item(i).dayNo;var affair=result.rows.item(i).affair;var bgcolor=result.rows.item(i).bgcolor;formatDiary(id,dayNo,beginTime,endTime,affair,bgcolor)}}console.info("查询数据成功！")},function(ts,message){console.info("查询数据失败！"+message)})})}selectPlanList();function setPlanCard(id,h,top,left,bg,time,text){var diary='<div class="details" style="height:'+h+"px;top:"+top+"px;left:"+left+"%;background-color:"+bg+';">';var span='<span class="details-time">'+time+"</span>";var p='<p class="details-text">'+text+"</p>";var editSpan='<span title="Edit Plan" class="details-edit" mid="'+id+'"></span>';var modifySpan='<span title="Delete Plan" class="details-delete"mid="'+id+'"></span>';diary+=span;diary+=p;diary+=editSpan;diary+=modifySpan;$("#container").append(diary)}function formatDiary(id,dayNo,beginTime,endTime,affair,bgcolor){var h=formatHeight(beginTime,endTime);var top=formatTop(beginTime);var time=beginTime+"-"+endTime;var left;if(dayNo=="Monday"){left=0}else{if(dayNo=="Tuesday"){left=20}else{if(dayNo=="Wednesday"){left=40}else{if(dayNo=="Thursday"){left=60}else{left=80}}}}setPlanCard(id,h,top,left,bgcolor,time,affair)}function formatHeight(begin,end){var beginNo,endNo,h;if(begin.substr(1,1)=="9"){beginNo=9}else{beginNo=begin.substr(0,2)}endNo=end.substr(0,2);h=(endNo-beginNo)*100;return h}function formatTop(begin){var beginNo,top;if(begin.substr(1,1)=="9"){beginNo=9}else{beginNo=begin.substr(0,2)}top=(beginNo-9)*100;return top}function formatLeft(dayNo){if(dayNo=="Monday"){return 0}else{if(dayNo=="Tuesday"){return 20}else{if(dayNo=="Wednesday"){return 40}else{if(dayNo=="Thursday"){return 60}else{return 80}}}}}$(".details-delete").live("click",function(){var com=window.confirm("Deleting!Are you sure?");if(com){var id=$(this).attr("mid");insertLog("delete plan card");deletePlanList(id)}});function deletePlanList(id){var db=getCurrentDb();db.transaction(function(ts){ts.executeSql("delete from planList where id = ? ",[id],function(ts,result){console.info("删除数据成功！"+result);window.location.reload()},function(ts,message){console.info("删除数据失败！"+message);window.alert("删除数据失败！")})})}window.ModifyId=1;$(".details-edit").live("click",function(){selectPlanList();$(".modify-container").attr("style","display:block;");$(".details").attr("style","opacity: 0.3;");$(".main").attr("style","opacity: 0.3;");
var mid=$(this).attr("mid");window.ModifyId=mid;selectPlanListById(mid)});function selectPlanListById(id){var db=getCurrentDb();db.transaction(function(ts){ts.executeSql("select * from planList where id=?",[id],function(ts,result){if(result){for(var i=0;i<result.rows.length;i++){console.info((result.rows.item(i)));var id=result.rows.item(i).id;var beginTime=result.rows.item(i).beginTime;var endTime=result.rows.item(i).endTime;var dayNo=result.rows.item(i).dayNo;var affair=result.rows.item(i).affair;var bgcolor=result.rows.item(i).bgcolor;$("#modify-affair").val(affair);$("#modify-beginTime").val(beginTime);$("#modify-endTime").val(endTime);$("#modify-weekdayNo").val(dayNo);$("#modify-bgcolor").val(bgcolor)}}console.info("查询数据成功！")},function(ts,message){console.info("查询数据失败！"+message)})})}$("#modify-main-button").click(function(){var dayNo=$("#modify-weekdayNo").find("option:selected").text();var beginTime=$("#modify-beginTime").find("option:selected").text();var endTime=$("#modify-endTime").find("option:selected").text();var affair=$("#modify-affair").val();var bgcolor=$("#modify-bgcolor").find("option:selected").text();var id=window.ModifyId;insertLog("update plan card");updatePlanList(dayNo,beginTime,endTime,affair,bgcolor,id)});$("#cancel-modify-button").click(function(){selectPlanList();$(".modify-container").attr("style","display:none;");$(".details").attr("style","opacity: 1;");$(".main").attr("style","opacity: 1;")});function updatePlanList(dayNo,beginTime,endTime,affair,bgcolor,id){var db=getCurrentDb();db.transaction(function(ts){ts.executeSql("update planList set dayNo=?,beginTime=?,endTime=?,affair=?,bgcolor=? where id = ? ",[dayNo,beginTime,endTime,affair,bgcolor,id],function(ts,result){console.info("更新数据成功！"+result);window.location.reload()},function(ts,message){console.info("更新数据失败！"+message)})})}window.LookLogFalsh=0;function insertLog(operation){var id;var time=getNowFormatDate();var db=getCurrentDb();db.transaction(function(ts){var size=localStorage.getItem("lsize");if(size==null){localStorage.setItem("lsize",1);id=1}else{size=parseInt(size)+parseInt(1);localStorage.setItem("lsize",size);id=size}ts.executeSql("insert into log(id,operation,time) values(?,?,?) ",[id,operation,time],function(ts,result){console.dir("插入日志数据成功！"+result)},function(ts,message){console.info("插入数据失败！"+message)})})}$("#look-log").click(function(){var play=$("#log-main").css("display");if(play=="none"){$("#log-main").css("display","block");if(LookLogFalsh==0){selectLog();LookLogFalsh=1}}else{$("#log-main").css("display","none")}});function setLog(operation,time){var log='<div class="log-row"><span class="log-span">';log+=operation;log+='</span><span class="log-span ">';log+=time;log+="</span></div>";$("#log-main").append(log)}function getNowFormatDate(){var date=new Date();var seperator1="-";var seperator2=":";var month=date.getMonth()+1;var strDate=date.getDate();if(month>=1&&month<=9){month="0"+month}if(strDate>=0&&strDate<=9){strDate="0"+strDate}var currentdate=date.getFullYear()+seperator1+month+seperator1+strDate+" "+date.getHours()+seperator2+date.getMinutes()+seperator2+date.getSeconds();return currentdate}function selectLog(){var db=getCurrentDb();db.transaction(function(ts){ts.executeSql("select * from log ",[],function(ts,result){if(result){if(result.rows.length==0){LookLogFalsh=0}for(var i=0;i<result.rows.length;i++){console.info((result.rows.item(i)));var operation=result.rows.item(i).operation;var time=result.rows.item(i).Time;setLog(operation,time)}}console.info("查询数据成功！")},function(ts,message){console.info("查询数据失败！"+message)})})};